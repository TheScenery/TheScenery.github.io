<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
<meta name="viewport" content="width=device-width,minimum-scale=1">




<title>å¾®å‰ç«¯æ¡†æ¶ä¹‹qiankunåˆæ¢ | TheScenery&#39;s Blog</title>
<link rel="canonical" href="https://thescenery.github.io/posts/%E5%BE%AE%E5%89%8D%E7%AB%AF%E6%A1%86%E6%9E%B6%E4%B9%8Bqiankun%E5%88%9D%E6%8E%A2/">
<meta name="description" content="å¾®å‰ç«¯æ˜¯å¯ä»¥ç”¨æ¥æ„å»ºèƒ½å¤Ÿè®©å¤šä¸ªå›¢é˜Ÿç‹¬ç«‹äº¤ä»˜é¡¹ç›®ä»£ç çš„ç°ä»£web app æŠ€æœ¯ï¼Œç­–ç•¥ä»¥åŠå®è·µæ–¹æ³•" />
<meta property="og:type" content="article" />
<meta property="og:title" content="å¾®å‰ç«¯æ¡†æ¶ä¹‹qiankunåˆæ¢ | TheScenery&#39;s Blog" />
<meta property="og:url" content="https://thescenery.github.io/posts/%E5%BE%AE%E5%89%8D%E7%AB%AF%E6%A1%86%E6%9E%B6%E4%B9%8Bqiankun%E5%88%9D%E6%8E%A2/" />
<meta property="og:description" content="å¾®å‰ç«¯æ˜¯å¯ä»¥ç”¨æ¥æ„å»ºèƒ½å¤Ÿè®©å¤šä¸ªå›¢é˜Ÿç‹¬ç«‹äº¤ä»˜é¡¹ç›®ä»£ç çš„ç°ä»£web app æŠ€æœ¯ï¼Œç­–ç•¥ä»¥åŠå®è·µæ–¹æ³•" />








<link rel="stylesheet" href="/lib/icofont/icofont.min.css" />
<link rel="stylesheet" href="/css/syntax.css" />
<link rel="stylesheet" href="/css/style.css" />
<link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon" />

    </head>

    <body>
        <header class="header-wrapper">
    <div class="header">
        <a class="site-title" href="https://thescenery.github.io/">TheScenery&#39;s Blog</a>

        <nav class="menu">
            
        </nav>
    </div>
</header>

        <main class="main-wrapper">
            <div class="main">
                

<section class="single">
    <h1 class="title">å¾®å‰ç«¯æ¡†æ¶ä¹‹qiankunåˆæ¢</h1>

    <div class="tip">
        <time datetime="2022-06-25 11:14:24 &#43;0000 UTC">2022/06/25</time>
        <span class="split">Â·</span>
        <span> 1013 words </span>
        <span class="split">Â·</span>
        <span>
            5 minutes to read
        </span>
    </div>

    <div class="taxonomies">
        
        <div>
            Categories:
            
                <a href="/categories/%E5%AD%A6%E4%B9%A0">å­¦ä¹ </a>
            
        </div>
        

        
    </div>

    <hr />

    <div class="content">
        <p>Techniques, strategies and recipes for building a <!-- raw HTML omitted -->modern web app<!-- raw HTML omitted --> with <!-- raw HTML omitted -->multiple teams<!-- raw HTML omitted --> that can <!-- raw HTML omitted -->ship features independently<!-- raw HTML omitted -->. â€”â€”â€”â€” <a href="https://micro-frontends.org/">Micro Frontends</a></p>
<p><code>å¾®å‰ç«¯æ˜¯å¯ä»¥ç”¨æ¥æ„å»ºèƒ½å¤Ÿè®©å¤šä¸ªå›¢é˜Ÿç‹¬ç«‹äº¤ä»˜é¡¹ç›®ä»£ç çš„ç°ä»£web app æŠ€æœ¯ï¼Œç­–ç•¥ä»¥åŠå®è·µæ–¹æ³•</code></p>
<p><img src="/images/qiankun/verticals-headline.png" alt=""></p>
<p>å¾®å‰ç«¯æ¶æ„æ—¨åœ¨è§£å†³å•ä½“åº”ç”¨åœ¨ä¸€ä¸ªç›¸å¯¹é•¿çš„æ—¶é—´è·¨åº¦ä¸‹ï¼Œç”±äºå‚ä¸çš„äººå‘˜ã€å›¢é˜Ÿçš„å¢å¤šã€å˜è¿ï¼Œä»ä¸€ä¸ªæ™®é€šåº”ç”¨æ¼”å˜æˆä¸€ä¸ªå·¨çŸ³åº”ç”¨(Frontend Monolith)åï¼Œéšä¹‹è€Œæ¥çš„åº”ç”¨ä¸å¯ç»´æŠ¤çš„é—®é¢˜ã€‚è¿™ç±»é—®é¢˜åœ¨ä¼ä¸šçº§ Web åº”ç”¨ä¸­å°¤å…¶å¸¸è§ã€‚</p>
<p><img src="/images/qiankun/three-teams.png" alt="ç”ŸåŠ¨å½¢è±¡çš„ä¾‹å­"></p>
<h2 id="å¾®å‰ç«¯çš„æ ¸å¿ƒæ€æƒ³">å¾®å‰ç«¯çš„æ ¸å¿ƒæ€æƒ³ <a href="#%e5%be%ae%e5%89%8d%e7%ab%af%e7%9a%84%e6%a0%b8%e5%bf%83%e6%80%9d%e6%83%b3" class="anchor">ğŸ”—</a></h2><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-txt" data-lang="txt"><span style="display:flex;"><span>Be Technology Agnostic(æŠ€æœ¯ä¸å¯çŸ¥ä¸»ä¹‰)
</span></span><span style="display:flex;"><span>Isolate Team Code(éš”ç¦»å›¢é˜Ÿä¹‹é—´çš„ä»£ç )
</span></span><span style="display:flex;"><span>Establish Team Prefixes(å»ºç«‹å›¢é˜Ÿè‡ªå·±çš„å‰ç¼€)
</span></span><span style="display:flex;"><span>Favor Native Browser Features over Custom APIs(åŸç”Ÿæµè§ˆå™¨æ ‡å‡†ä¼˜å…ˆäºæ¡†æ¶å°è£…çš„API)
</span></span><span style="display:flex;"><span>Build a Resilient Site(æ„å»ºé«˜å¯ç”¨çš„ç½‘ç»œåº”ç”¨)
</span></span></code></pre></div><h2 id="å¾®å‰ç«¯çš„ä»·å€¼">å¾®å‰ç«¯çš„ä»·å€¼ <a href="#%e5%be%ae%e5%89%8d%e7%ab%af%e7%9a%84%e4%bb%b7%e5%80%bc" class="anchor">ğŸ”—</a></h2><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-txt" data-lang="txt"><span style="display:flex;"><span>æŠ€æœ¯æ ˆæ— å…³
</span></span><span style="display:flex;"><span>ç‹¬ç«‹å¼€å‘ã€ç‹¬ç«‹éƒ¨ç½²
</span></span><span style="display:flex;"><span>å¢é‡å‡çº§
</span></span><span style="display:flex;"><span>ç‹¬ç«‹è¿è¡Œæ—¶
</span></span></code></pre></div><h2 id="qiankun-ä¹¾å¤æ˜¯ä»€ä¹ˆ">qiankun (ä¹¾å¤)æ˜¯ä»€ä¹ˆï¼Ÿ <a href="#qiankun-%e4%b9%be%e5%9d%a4%e6%98%af%e4%bb%80%e4%b9%88" class="anchor">ğŸ”—</a></h2><p><code>In Chinese, qian(ä¹¾) means heaven and kun(å¤) earth. qiankun is the universe.</code></p>
<p>ä¹¾å¤æ˜¯ä¸€ä¸ªåŸºäº <a href="https://github.com/single-spa/single-spa">single-spa</a> çš„å¾®å‰ç«¯å®ç°åº“ï¼Œæ—¨åœ¨å¸®åŠ©å¤§å®¶èƒ½æ›´ç®€å•ã€æ— ç—›çš„æ„å»ºä¸€ä¸ªç”Ÿäº§å¯ç”¨å¾®å‰ç«¯æ¶æ„ç³»ç»Ÿã€‚</p>
<p><code>ç®€å•</code>  <code>è§£è€¦/æŠ€æœ¯æ ˆæ— å…³</code></p>
<h3 id="ç‰¹æ€§">ç‰¹æ€§ <a href="#%e7%89%b9%e6%80%a7" class="anchor">ğŸ”—</a></h3><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-txt" data-lang="txt"><span style="display:flex;"><span>åŸºäº single-spa å°è£…
</span></span><span style="display:flex;"><span>HTML Entry
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>æŠ€æœ¯æ ˆæ— å…³
</span></span><span style="display:flex;"><span>æ ·å¼éš”ç¦»
</span></span><span style="display:flex;"><span>JS æ²™ç®±
</span></span><span style="display:flex;"><span>èµ„æºé¢„åŠ è½½
</span></span><span style="display:flex;"><span>umi æ’ä»¶
</span></span></code></pre></div><h2 id="å¦‚ä½•å·¥ä½œçš„">å¦‚ä½•å·¥ä½œçš„ <a href="#%e5%a6%82%e4%bd%95%e5%b7%a5%e4%bd%9c%e7%9a%84" class="anchor">ğŸ”—</a></h2><p><img src="/images/qiankun/master-slave.jpeg" alt="ä¸»åº”ç”¨&amp;å¾®åº”ç”¨"></p>
<h3 id="ä½¿ç”¨æ–¹æ³•">ä½¿ç”¨æ–¹æ³• <a href="#%e4%bd%bf%e7%94%a8%e6%96%b9%e6%b3%95" class="anchor">ğŸ”—</a></h3><p>ä¸»åº”ç”¨å®‰è£…ä¹¾å¤æ¡†æ¶</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yarn add qiankun <span style="color:#75715e"># æˆ–è€… npm i qiankun -S</span>
</span></span></code></pre></div><p>ä¸»åº”ç”¨ä¸­æ³¨å†Œå¾®åº”ç”¨</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">registerMicroApps</span>, <span style="color:#a6e22e">start</span>, <span style="color:#a6e22e">loadMicroApp</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;qiankun&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// è‡ªåŠ¨åŒ¹é…
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">registerMicroApps</span>([
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;react app&#39;</span>, <span style="color:#75715e">// app name registered
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">entry</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;//localhost:7100&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">container</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;#yourContainer&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">activeRule</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;/yourActiveRule&#39;</span>,
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;vue app&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">entry</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">scripts</span><span style="color:#f92672">:</span> [<span style="color:#e6db74">&#39;//localhost:7100/main.js&#39;</span>] },
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">container</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;#yourContainer2&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">activeRule</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;/yourActiveRule2&#39;</span>,
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">start</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// æ‰‹åŠ¨åŠ è½½
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">loadMicroApp</span>({
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;app&#39;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">entry</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;//localhost:7100&#39;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">container</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;#yourContainer&#39;</span>,
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><p>å¾®åº”ç”¨å¯¼å‡ºç”Ÿå‘½å‘¨æœŸé’©å­</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * bootstrap åªä¼šåœ¨å¾®åº”ç”¨åˆå§‹åŒ–çš„æ—¶å€™è°ƒç”¨ä¸€æ¬¡ï¼Œä¸‹æ¬¡å¾®åº”ç”¨é‡æ–°è¿›å…¥æ—¶ä¼šç›´æ¥è°ƒç”¨ mount é’©å­ï¼Œä¸ä¼šå†é‡å¤è§¦å‘ bootstrapã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * é€šå¸¸æˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œåšä¸€äº›å…¨å±€å˜é‡çš„åˆå§‹åŒ–ï¼Œæ¯”å¦‚ä¸ä¼šåœ¨ unmount é˜¶æ®µè¢«é”€æ¯çš„åº”ç”¨çº§åˆ«çš„ç¼“å­˜ç­‰ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">bootstrap</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#39;react app bootstraped&#39;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * åº”ç”¨æ¯æ¬¡è¿›å…¥éƒ½ä¼šè°ƒç”¨ mount æ–¹æ³•ï¼Œé€šå¸¸æˆ‘ä»¬åœ¨è¿™é‡Œè§¦å‘åº”ç”¨çš„æ¸²æŸ“æ–¹æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">mount</span>(<span style="color:#a6e22e">props</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">ReactDOM</span>.<span style="color:#a6e22e">render</span>(<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">App</span> <span style="color:#f92672">/&gt;</span>, <span style="color:#a6e22e">props</span>.<span style="color:#a6e22e">container</span> <span style="color:#f92672">?</span> <span style="color:#a6e22e">props</span>.<span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">querySelector</span>(<span style="color:#e6db74">&#39;#root&#39;</span>) <span style="color:#f92672">:</span> document.<span style="color:#a6e22e">getElementById</span>(<span style="color:#e6db74">&#39;root&#39;</span>));
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * åº”ç”¨æ¯æ¬¡ åˆ‡å‡º/å¸è½½ ä¼šè°ƒç”¨çš„æ–¹æ³•ï¼Œé€šå¸¸åœ¨è¿™é‡Œæˆ‘ä»¬ä¼šå¸è½½å¾®åº”ç”¨çš„åº”ç”¨å®ä¾‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">unmount</span>(<span style="color:#a6e22e">props</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">ReactDOM</span>.<span style="color:#a6e22e">unmountComponentAtNode</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">props</span>.<span style="color:#a6e22e">container</span> <span style="color:#f92672">?</span> <span style="color:#a6e22e">props</span>.<span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">querySelector</span>(<span style="color:#e6db74">&#39;#root&#39;</span>) <span style="color:#f92672">:</span> document.<span style="color:#a6e22e">getElementById</span>(<span style="color:#e6db74">&#39;root&#39;</span>),
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * å¯é€‰ç”Ÿå‘½å‘¨æœŸé’©å­ï¼Œä»…ä½¿ç”¨ loadMicroApp æ–¹å¼åŠ è½½å¾®åº”ç”¨æ—¶ç”Ÿæ•ˆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">update</span>(<span style="color:#a6e22e">props</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#39;update props&#39;</span>, <span style="color:#a6e22e">props</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å¾®åº”ç”¨æš´éœ²å‡ºé¢å¤–çš„ä¸€äº›ä¿¡æ¯ï¼Œä¿®æ”¹é…ç½®</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">packageName</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;./package.json&#39;</span>).<span style="color:#a6e22e">name</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">module</span>.<span style="color:#a6e22e">exports</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">output</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">library</span><span style="color:#f92672">:</span> <span style="color:#e6db74">`</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">packageName</span><span style="color:#e6db74">}</span><span style="color:#e6db74">-[name]`</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">libraryTarget</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;umd&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">jsonpFunction</span><span style="color:#f92672">:</span> <span style="color:#e6db74">`webpackJsonp_</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">packageName</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>,
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><h3 id="å®ç°åŸç†">å®ç°åŸç† <a href="#%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86" class="anchor">ğŸ”—</a></h3><h4 id="åŠ è½½æ–¹å¼html-entry">åŠ è½½æ–¹å¼â€”â€”HTML Entry <a href="#%e5%8a%a0%e8%bd%bd%e6%96%b9%e5%bc%8fhtml-entry" class="anchor">ğŸ”—</a></h4><p>qiankunä½¿ç”¨ç‹¬ç«‹çš„å¤„ç†åº“<a href="https://github.com/kuitos/import-html-entry#readme">import-html-entry</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">loadApp</span>&lt;<span style="color:#f92672">T</span> <span style="color:#a6e22e">extends</span> <span style="color:#a6e22e">ObjectType</span>&gt;(
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">app</span>: <span style="color:#66d9ef">LoadableApp</span>&lt;<span style="color:#f92672">T</span>&gt;,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">configuration</span>: <span style="color:#66d9ef">FrameworkConfiguration</span> <span style="color:#f92672">=</span> {},
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">lifeCycles?</span>: <span style="color:#66d9ef">FrameworkLifeCycles</span>&lt;<span style="color:#f92672">T</span>&gt;,
</span></span><span style="display:flex;"><span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">ParcelConfigObjectGetter</span>&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">entry</span>, <span style="color:#a6e22e">name</span>: <span style="color:#66d9ef">appName</span> } <span style="color:#f92672">=</span> <span style="color:#a6e22e">app</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">appInstanceId</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">genAppInstanceIdByName</span>(<span style="color:#a6e22e">appName</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">markName</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">`[qiankun] App </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">appInstanceId</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> Loading`</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">env</span>.<span style="color:#a6e22e">NODE_ENV</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;development&#39;</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">performanceMark</span>(<span style="color:#a6e22e">markName</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">singular</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sandbox</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">excludeAssetFilter</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">globalContext</span> <span style="color:#f92672">=</span> window,
</span></span><span style="display:flex;"><span>    ...<span style="color:#a6e22e">importEntryOpts</span>
</span></span><span style="display:flex;"><span>  } <span style="color:#f92672">=</span> <span style="color:#a6e22e">configuration</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// get the entry html content and script executor
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  1. template å¤„ç†åçš„html
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  2. execScripts æ‰§è¡Œè„šæœ¬
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  3. assetPublicPath å…¬å…±è·¯å¾„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">template</span>, <span style="color:#a6e22e">execScripts</span>, <span style="color:#a6e22e">assetPublicPath</span> } <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">importEntry</span>(<span style="color:#a6e22e">entry</span>, <span style="color:#a6e22e">importEntryOpts</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">///...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><h4 id="jsæ²™ç®±å®ç°æ–¹å¼">JSæ²™ç®±å®ç°æ–¹å¼ <a href="#js%e6%b2%99%e7%ae%b1%e5%ae%9e%e7%8e%b0%e6%96%b9%e5%bc%8f" class="anchor">ğŸ”—</a></h4><p>qiankunä¸­é‡‡å–äº†ä¸¤ç§æ–¹å¼æ¥æ”¯æŒJSæ²™ç®±</p>
<ol>
<li>ä¸æ”¯æŒProxyçš„ï¼Œåˆ™ç®€å•çš„è®²windowå¤‡ä»½ä¸€ä¸ªï¼Œä½¿ç”¨å®Œåæ¢å¤</li>
<li>æ”¯æŒProxyçš„ï¼Œä½¿ç”¨Proxyåçš„windowä½œä¸ºå…¨å±€å¯¹è±¡ï¼Œgetä»windowä¸Šè·å–ï¼Œsetä¸å¾€windowä¸Šè®¾ç½®</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">createSandboxContainer</span>(
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">appName</span>: <span style="color:#66d9ef">string</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">elementGetter</span><span style="color:#f92672">:</span> () <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">HTMLElement</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">ShadowRoot</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">scopedCSS</span>: <span style="color:#66d9ef">boolean</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">useLooseSandbox?</span>: <span style="color:#66d9ef">boolean</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">excludeAssetFilter</span><span style="color:#f92672">?:</span> (<span style="color:#a6e22e">url</span>: <span style="color:#66d9ef">string</span>) <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">boolean</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">globalContext?</span>: <span style="color:#66d9ef">typeof</span> window,
</span></span><span style="display:flex;"><span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">sandbox</span>: <span style="color:#66d9ef">SandBox</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (window.<span style="color:#a6e22e">Proxy</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sandbox</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">useLooseSandbox</span> <span style="color:#f92672">?</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">LegacySandbox</span>(<span style="color:#a6e22e">appName</span>, <span style="color:#a6e22e">globalContext</span>) <span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ProxySandbox</span>(<span style="color:#a6e22e">appName</span>, <span style="color:#a6e22e">globalContext</span>);
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sandbox</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">SnapshotSandbox</span>(<span style="color:#a6e22e">appName</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">//...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p>é€šè¿‡Snapshotæ–¹å¼å®ç°æ²™ç®±</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">default</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SnapshotSandbox</span> <span style="color:#66d9ef">implements</span> <span style="color:#a6e22e">SandBox</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">proxy</span>: <span style="color:#66d9ef">WindowProxy</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">name</span>: <span style="color:#66d9ef">string</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">type</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">SandBoxType</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">sandboxRunning</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">windowSnapshot</span><span style="color:#f92672">!:</span> <span style="color:#a6e22e">Window</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">modifyPropsMap</span>: <span style="color:#66d9ef">Record</span>&lt;<span style="color:#f92672">any</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">any</span>&gt; <span style="color:#f92672">=</span> {};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">constructor</span>(<span style="color:#a6e22e">name</span>: <span style="color:#66d9ef">string</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">name</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">name</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">proxy</span> <span style="color:#f92672">=</span> window;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#66d9ef">type</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">SandBoxType</span>.<span style="color:#a6e22e">Snapshot</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">active() {</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// è®°å½•å½“å‰å¿«ç…§
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">windowSnapshot</span> <span style="color:#f92672">=</span> {} <span style="color:#66d9ef">as</span> <span style="color:#a6e22e">Window</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">iter</span>(window, (<span style="color:#a6e22e">prop</span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">windowSnapshot</span>[<span style="color:#a6e22e">prop</span>] <span style="color:#f92672">=</span> window[<span style="color:#a6e22e">prop</span>];
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// æ¢å¤ä¹‹å‰çš„å˜æ›´
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Object.<span style="color:#a6e22e">keys</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">modifyPropsMap</span>).<span style="color:#a6e22e">forEach</span>((<span style="color:#a6e22e">p</span>: <span style="color:#66d9ef">any</span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>      window[<span style="color:#a6e22e">p</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">modifyPropsMap</span>[<span style="color:#a6e22e">p</span>];
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">sandboxRunning</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">inactive() {</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">modifyPropsMap</span> <span style="color:#f92672">=</span> {};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">iter</span>(window, (<span style="color:#a6e22e">prop</span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (window[<span style="color:#a6e22e">prop</span>] <span style="color:#f92672">!==</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">windowSnapshot</span>[<span style="color:#a6e22e">prop</span>]) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// è®°å½•å˜æ›´ï¼Œæ¢å¤ç¯å¢ƒ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">modifyPropsMap</span>[<span style="color:#a6e22e">prop</span>] <span style="color:#f92672">=</span> window[<span style="color:#a6e22e">prop</span>];
</span></span><span style="display:flex;"><span>        window[<span style="color:#a6e22e">prop</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">windowSnapshot</span>[<span style="color:#a6e22e">prop</span>];
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">env</span>.<span style="color:#a6e22e">NODE_ENV</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;development&#39;</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">`[qiankun:sandbox] </span><span style="color:#e6db74">${</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">name</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> origin window restore...`</span>, Object.<span style="color:#a6e22e">keys</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">modifyPropsMap</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">sandboxRunning</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ä½¿ç”¨snapshotåˆ›å»ºæ²™ç®±ç¯å¢ƒçš„åŸºæœ¬åŸç†ä¸ºï¼Œä½¿ç”¨ä¹‹å‰å¯¹å½“å‰ä¸Šä¸‹æ–‡åšå¿«ç…§ï¼Œä½¿ç”¨å®Œæˆä¹‹åå†ä»å¿«ç…§æ¢å¤ä¸Šä¸‹æ–‡ã€‚å› æ­¤ï¼Œè¿™ç§æ–¹å¼åˆ›å»ºçš„æ²™ç®±å…¶å®åœ¨ç”Ÿæ•ˆçš„è¿‡ç¨‹ä¸­ï¼Œæ‰€æœ‰å¯¹äºä¸Šä¸‹æ–‡çš„æ“ä½œå…¶å®éƒ½æ˜¯åœ¨windowä¸Šè¿›è¡Œçš„ï¼Œä¹Ÿæ­£æ˜¯è¿™ç§åŸç†ï¼Œå†³å®šäº†ä½¿ç”¨è¿™ç§æ–¹å¼åˆ›å»ºçš„æ²™ç®±ï¼ŒåŒæ—¶é—´åªèƒ½å­˜åœ¨ä¸€ä¸ªæ¿€æ´»çš„ï¼Œä¸èƒ½åŒæ—¶å¼€å¯ï¼Œæ˜ å°„åˆ°å¾®å‰ç«¯ä¸­ä¹Ÿå°±æ„å‘³ç€åŒæ—¶åªèƒ½æ¿€æ´»ä¸€ä¸ªå¾®åº”ç”¨ã€‚</p>
<p>é€šè¿‡Proxyå®ç°JSæ²™ç®±</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-TYPESCRIPT" data-lang="TYPESCRIPT"><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">default</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ProxySandbox</span> <span style="color:#66d9ef">implements</span> <span style="color:#a6e22e">SandBox</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">//...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">proxy</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Proxy</span>(<span style="color:#a6e22e">fakeWindow</span>, {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// setæ—¶ç»™fakeWindowè®¾ç½®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">set</span><span style="color:#f92672">:</span> (<span style="color:#a6e22e">target</span>: <span style="color:#66d9ef">FakeWindow</span>, <span style="color:#a6e22e">p</span>: <span style="color:#66d9ef">PropertyKey</span>, <span style="color:#a6e22e">value</span>: <span style="color:#66d9ef">any</span>)<span style="color:#f92672">:</span> <span style="color:#66d9ef">boolean</span> <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">sandboxRunning</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">registerRunningApp</span>(<span style="color:#a6e22e">name</span>, <span style="color:#a6e22e">proxy</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#75715e">// We must kept its description while the property existed in globalContext before
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>          <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">target</span>.<span style="color:#a6e22e">hasOwnProperty</span>(<span style="color:#a6e22e">p</span>) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">globalContext</span>.<span style="color:#a6e22e">hasOwnProperty</span>(<span style="color:#a6e22e">p</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">descriptor</span> <span style="color:#f92672">=</span> Object.<span style="color:#a6e22e">getOwnPropertyDescriptor</span>(<span style="color:#a6e22e">globalContext</span>, <span style="color:#a6e22e">p</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">writable</span>, <span style="color:#a6e22e">configurable</span>, <span style="color:#a6e22e">enumerable</span> } <span style="color:#f92672">=</span> <span style="color:#a6e22e">descriptor</span><span style="color:#f92672">!</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">writable</span>) {
</span></span><span style="display:flex;"><span>              Object.<span style="color:#a6e22e">defineProperty</span>(<span style="color:#a6e22e">target</span>, <span style="color:#a6e22e">p</span>, {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">configurable</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">enumerable</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">writable</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">value</span>,
</span></span><span style="display:flex;"><span>              });
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>          } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// @ts-ignore
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#a6e22e">target</span>[<span style="color:#a6e22e">p</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">value</span>;
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">variableWhiteList</span>.<span style="color:#a6e22e">indexOf</span>(<span style="color:#a6e22e">p</span>) <span style="color:#f92672">!==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// @ts-ignore
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#a6e22e">globalContext</span>[<span style="color:#a6e22e">p</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">value</span>;
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">updatedValueSet</span>.<span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">p</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">latestSetProp</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">p</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">env</span>.<span style="color:#a6e22e">NODE_ENV</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;development&#39;</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">warn</span>(<span style="color:#e6db74">`[qiankun] Set window.</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">toString</span>()<span style="color:#e6db74">}</span><span style="color:#e6db74"> while sandbox destroyed or inactive in </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">name</span><span style="color:#e6db74">}</span><span style="color:#e6db74">!`</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// åœ¨ strict-mode ä¸‹ï¼ŒProxy çš„ handler.set è¿”å› false ä¼šæŠ›å‡º TypeErrorï¼Œåœ¨æ²™ç®±å¸è½½çš„æƒ…å†µä¸‹åº”è¯¥å¿½ç•¥é”™è¯¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// getæ—¶å…ˆä»FakeWindowä¸Šè·å–ï¼Œå¦‚æœè·å–ä¸åˆ°åˆ™å»Windowä¸Šè·å–
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">get</span><span style="color:#f92672">:</span> (<span style="color:#a6e22e">target</span>: <span style="color:#66d9ef">FakeWindow</span>, <span style="color:#a6e22e">p</span>: <span style="color:#66d9ef">PropertyKey</span>)<span style="color:#f92672">:</span> <span style="color:#66d9ef">any</span> <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">registerRunningApp</span>(<span style="color:#a6e22e">name</span>, <span style="color:#a6e22e">proxy</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">Symbol</span>.<span style="color:#a6e22e">unscopables</span>) <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">unscopables</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// avoid who using window.window or window.self to escape the sandbox environment to touch the really window
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// see https://github.com/eligrey/FileSaver.js/blob/master/src/FileSaver.js#L13
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;window&#39;</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">p</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;self&#39;</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">proxy</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// hijack globalWindow accessing with globalThis keyword
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;globalThis&#39;</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">proxy</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">p</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;top&#39;</span> <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">p</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;parent&#39;</span> <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>          (<span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">env</span>.<span style="color:#a6e22e">NODE_ENV</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;test&#39;</span> <span style="color:#f92672">&amp;&amp;</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;mockTop&#39;</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">p</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;mockSafariTop&#39;</span>))
</span></span><span style="display:flex;"><span>        ) {
</span></span><span style="display:flex;"><span>          <span style="color:#75715e">// if your master app in an iframe context, allow these props escape the sandbox
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>          <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">globalContext</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">globalContext</span>.<span style="color:#a6e22e">parent</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">proxy</span>;
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">return</span> (<span style="color:#a6e22e">globalContext</span> <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">any</span>)[<span style="color:#a6e22e">p</span>];
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// proxy.hasOwnProperty would invoke getter firstly, then its value represented as globalContext.hasOwnProperty
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;hasOwnProperty&#39;</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">hasOwnProperty</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;document&#39;</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">return</span> document;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;eval&#39;</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">return</span> eval;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">value</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">propertiesWithGetter</span>.<span style="color:#a6e22e">has</span>(<span style="color:#a6e22e">p</span>)
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">?</span> (<span style="color:#a6e22e">globalContext</span> <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">any</span>)[<span style="color:#a6e22e">p</span>]
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">:</span> <span style="color:#a6e22e">p</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">target</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">?</span> (<span style="color:#a6e22e">target</span> <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">any</span>)[<span style="color:#a6e22e">p</span>]
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">:</span> (<span style="color:#a6e22e">globalContext</span> <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">any</span>)[<span style="color:#a6e22e">p</span>];
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* Some dom api must be bound to native window, otherwise it would cause exception like &#39;TypeError: Failed to execute &#39;fetch&#39; on &#39;Window&#39;: Illegal invocation&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">           See this code:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             const proxy = new Proxy(window, {});
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             const proxyFetch = fetch.bind(proxy);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             proxyFetch(&#39;https://qiankun.com&#39;);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">boundTarget</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">useNativeWindowForBindingsProps</span>.<span style="color:#66d9ef">get</span>(<span style="color:#a6e22e">p</span>) <span style="color:#f92672">?</span> <span style="color:#a6e22e">nativeGlobal</span> : <span style="color:#66d9ef">globalContext</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">getTargetValue</span>(<span style="color:#a6e22e">boundTarget</span>, <span style="color:#a6e22e">value</span>);
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">proxy</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">proxy</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><h4 id="æ ·å¼éš”ç¦»">æ ·å¼éš”ç¦» <a href="#%e6%a0%b7%e5%bc%8f%e9%9a%94%e7%a6%bb" class="anchor">ğŸ”—</a></h4><p>åˆ›å»ºappWrapperæ—¶åšäº†ç‰¹æ®Šå¤„ç†</p>
<ol>
<li>ä½¿ç”¨strictStyleIsolationä½¿ç”¨shadowDOM</li>
<li>ä½¿ç”¨experimentalStyleIsolationï¼Œåœ¨appElementä¸Šæ·»åŠ å‰ç¼€éå†æ‰€æœ‰cssæ·»åŠ å‰ç¼€</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">createElement</span>(
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">appContent</span>: <span style="color:#66d9ef">string</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">strictStyleIsolation</span>: <span style="color:#66d9ef">boolean</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">scopedCSS</span>: <span style="color:#66d9ef">boolean</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">appInstanceId</span>: <span style="color:#66d9ef">string</span>,
</span></span><span style="display:flex;"><span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">HTMLElement</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">containerElement</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">createElement</span>(<span style="color:#e6db74">&#39;div&#39;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">containerElement</span>.<span style="color:#a6e22e">innerHTML</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">appContent</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// appContent always wrapped with a singular div
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">appElement</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">containerElement</span>.<span style="color:#a6e22e">firstChild</span> <span style="color:#66d9ef">as</span> <span style="color:#a6e22e">HTMLElement</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">strictStyleIsolation</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">supportShadowDOM</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">warn</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;[qiankun]: As current browser not support shadow dom, your strictStyleIsolation configuration will be ignored!&#39;</span>,
</span></span><span style="display:flex;"><span>      );
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">innerHTML</span> } <span style="color:#f92672">=</span> <span style="color:#a6e22e">appElement</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">appElement</span>.<span style="color:#a6e22e">innerHTML</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">shadow</span>: <span style="color:#66d9ef">ShadowRoot</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">appElement</span>.<span style="color:#a6e22e">attachShadow</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">shadow</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">appElement</span>.<span style="color:#a6e22e">attachShadow</span>({ <span style="color:#a6e22e">mode</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;open&#39;</span> });
</span></span><span style="display:flex;"><span>      } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// createShadowRoot was proposed in initial spec, which has then been deprecated
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">shadow</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">appElement</span> <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">any</span>).<span style="color:#a6e22e">createShadowRoot</span>();
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">shadow</span>.<span style="color:#a6e22e">innerHTML</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">innerHTML</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">scopedCSS</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">attr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">appElement</span>.<span style="color:#a6e22e">getAttribute</span>(<span style="color:#a6e22e">css</span>.<span style="color:#a6e22e">QiankunCSSRewriteAttr</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">attr</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">appElement</span>.<span style="color:#a6e22e">setAttribute</span>(<span style="color:#a6e22e">css</span>.<span style="color:#a6e22e">QiankunCSSRewriteAttr</span>, <span style="color:#a6e22e">appInstanceId</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">styleNodes</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">appElement</span>.<span style="color:#a6e22e">querySelectorAll</span>(<span style="color:#e6db74">&#39;style&#39;</span>) <span style="color:#f92672">||</span> [];
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">forEach</span>(<span style="color:#a6e22e">styleNodes</span>, (<span style="color:#a6e22e">stylesheetElement</span>: <span style="color:#66d9ef">HTMLStyleElement</span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">css</span>.<span style="color:#a6e22e">process</span>(<span style="color:#a6e22e">appElement</span><span style="color:#f92672">!</span>, <span style="color:#a6e22e">stylesheetElement</span>, <span style="color:#a6e22e">appInstanceId</span>);
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">appElement</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="demoæ¼”ç¤º">Demoæ¼”ç¤º <a href="#demo%e6%bc%94%e7%a4%ba" class="anchor">ğŸ”—</a></h2><p><a href="https://github.com/TheScenery/micro-frontend-basement">Qiankunå¾®å‰ç«¯æ¼”ç¤ºé¡¹ç›®</a></p>
<p><img src="/images/qiankun/qiankunDemo.png" alt="QiankunDemo"></p>

    </div>

    
</section>


            </div>
            <div class="side">
                
                    <div class="side-recent">
    <h2 class="side-title">
        <a href="/posts/">Recent Posts</a>
    </h2>
    <hr />

    <ul>
        
            <li>
                <a href="/posts/%E8%AE%B0%E4%B8%80%E6%AC%A1%E8%8E%AB%E5%90%8D%E5%85%B6%E5%A6%99%E7%9A%84%E5%89%8D%E7%AB%AF%E9%A1%B5%E9%9D%A2%E5%B4%A9%E6%BA%83/">è®°ä¸€æ¬¡è«åå…¶å¦™çš„å‰ç«¯é¡µé¢å´©æºƒ</a>
            </li>
        
            <li>
                <a href="/posts/%E5%BE%AE%E5%89%8D%E7%AB%AF%E6%A1%86%E6%9E%B6%E4%B9%8Bqiankun%E5%88%9D%E6%8E%A2/">å¾®å‰ç«¯æ¡†æ¶ä¹‹qiankunåˆæ¢</a>
            </li>
        
            <li>
                <a href="/posts/%E5%A6%82%E4%BD%95%E5%8F%91%E5%B8%83%E4%B8%80%E4%B8%AAgo-package/">å¦‚ä½•å‘å¸ƒä¸€ä¸ªgo package</a>
            </li>
        
            <li>
                <a href="/posts/javascript%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/">JavaScriptå†…å­˜æ³„æ¼</a>
            </li>
        
            <li>
                <a href="/posts/css%E5%8A%A8%E7%94%BB%E4%B9%8Btransition%E5%92%8Canimation/">cssåŠ¨ç”»ä¹‹transitionå’Œanimation</a>
            </li>
        
    </ul>
</div>

                
                <div class="side-categories">
    <h2>Categories</h2>
    <hr />

    <ul>
        
            <li>
                <a href="/categories/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA">åšå®¢æ­å»º(1)</a>
            </li>
        
            <li>
                <a href="/categories/%E5%AD%A6%E4%B9%A0">å­¦ä¹ (3)</a>
            </li>
        
    </ul>
</div>

                <div class="side-tags">
    <h2>Tags</h2>
    <hr />

    <ul>
        
            <li>
                <a href="/tags/blog">blog (2)</a>
            </li>
        
    </ul>
</div>

            </div>
        </main>
        <footer class="footer">
    <div class="footer-row">
        
            
            
                <a class="footer-item" href="https://thescenery.github.io/posts/index.xml">
                    Feed of Posts
                    <i class="icofont-rss"></i>
                </a>
            
        

        
            
            
        
    </div>

    
</footer>

    </body>
</html>
